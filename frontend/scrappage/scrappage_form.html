<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scrappage Network</title>
    <link rel="stylesheet" href="./src/styles/style.css" />
    <link rel="stylesheet" href="./src/styles/index.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <style>
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error-message {
        color: red;
        margin-top: 5px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header class="header" id="header">
      <div class="logo-container">
        <img src="./images/logoUpdated.png" alt="Logo" />
        <h3>Revive Wheels</h3>
      </div>
      <nav>
          <ul class="nav-links">
              <li><a href="../index.html" id="tab-style">Home</a></li>
              <li><a href="../ev_conversion/ev_coversion_ui.html" id="tab-style">EV Conversion</a></li>
              <li><a href="../market/market.html" id="tab-style">Buy or Sell</a></li>
              <li class="active"><a href="#" id="tab-style">Scrappage Network</a></li>
          </ul>            
      </nav>
      <div id="auth-container" class="auth-buttons"></div>
    </header>

    <div
      class="form-container"
      style="
        margin: 20px auto;
        max-width: 900px;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
      "
    >
      <form id="form-details">
        <div
          class="form-content"
          style="display: flex; justify-content: space-between; gap: 20px"
        >
          <!-- Left Section - User Details -->
          <div
            class="user-details"
            style="
              flex: 1;
              padding: 10px;
              border: 1px solid rgb(200, 200, 200);
              border-radius: 5px;
            "
          >
            <h1>User Details</h1>
            <label for="username">Name</label>
            <input
              id="username"
              type="text"
              placeholder="Enter Name"
              required
              style="width: 100%; padding: 8px"
            />
            <div id="name-error" class="error-message"></div>

            <label for="userphone">Phone Number</label>
            <input
              id="userphone"
              type="tel"
              placeholder="Enter Phone Number"
              required
              style="width: 100%; padding: 8px"
            />
            <div id="phone-error" class="error-message"></div>

            <label for="userAadhar">Aadhar Number</label>
            <input
              id="userAadhar"
              type="text"
              placeholder="Enter Aadhar Number"
              required
              style="width: 100%; padding: 8px"
            />
            <div id="aadhar-error" class="error-message"></div>
          </div>

          <!-- Right Section - Video -->
          <div
            class="video-section"
            style="
              flex: 1;
              display: flex;
              justify-content: center;
              align-items: center;
              border: 1px solid rgb(210, 210, 210);
              padding: 10px;
              border-radius: 5px;
            "
          >
            <video
              playsinline
              autoplay
              loop
              muted
              style="width: 100%; border-radius: 5px"
            >
              <source
                src="https://cdnl.iconscout.com/lottie/premium/thumb/application-form-animated-icon-download-in-lottie-json-gif-static-svg-file-formats--job-cv-resume-employment-fill-ui-pack-user-interface-icons-8609542.mp4"
                type="video/mp4"
              />
              Your browser does not support the video tag.
            </video>
          </div>
        </div>

        <!-- Vehicle Details -->
        <div
          style="
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgb(217, 215, 215);
            padding: 10px;
            border-radius: 5px;
          "
        >
          <h1>Vehicle Details</h1>
          <label for="vehicleNo">Vehicle No.</label>
          <input
            id="vehicleNo"
            type="text"
            placeholder="Enter Vehicle No."
            required
            style="width: 100%; padding: 8px"
          />
          <div id="vehicleNo-error" class="error-message"></div>

          <label for="vehicleRC">Vehicle RC</label>
          <input
            id="vehicleRC"
            type="file"
            style="width: 100%; padding: 8px"
            accept=".jpeg, .png,.jpg, .pdf"
          />

          <label for="vehicleModel">Vehicle Model</label>
          <input
            id="vehicleModel"
            type="text"
            placeholder="Enter Vehicle Model"
            required
            style="width: 100%; padding: 8px"
          />
          <div id="vehicleModel-error" class="error-message"></div>

          <label for="vehiclePhotos">Vehicle Photos</label>
          <input
            id="vehiclePhotos"
            type="file"
            style="width: 100%; padding: 8px"
            multiple
            accept=".jpeg, .png,.jpg,"
          />

          <label for="scrapApplication">Application Copy</label>
          <input
            id="scrapApplication"
            type="file"
            style="width: 100%; padding: 8px"
            accept=".jpeg, .png,.jpg, .pdf"
          />
        </div>

        <div style="display: flex; justify-content: center; margin-top: 15px">
          <button
            type="submit"
            id="submitButton"
            style="
              padding: 10px 20px;
              background: #007bff;
              color: white;
              border: none;
              border-radius: 5px;
            "
          >
            Submit the Form
          </button>
        </div>
        <div
          id="form-status"
          style="text-align: center; margin-top: 10px"
        ></div>
      </form>
    </div>

    <footer
      style="
        text-align: center;
        padding: 10px;
        background: #f1f1f1;
        margin-top: 20px;
      "
    >
      Â© 2023 Revive Wheels. All rights reserved.
    </footer>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/auth.js"></script> 
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("form-details");
    const submitBtn = document.getElementById("submitButton");
    const statusDiv = document.getElementById("form-status");

    // --- Initialize Supabase Client ---
    const supabaseUrl = "https://prwgvnyjkeeblrliaffy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByd2d2bnlqa2VlYmxybGlhZmZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNDIxMzQsImV4cCI6MjA2ODkxODEzNH0.1yWTyG29KCrWpNNovBssRHLcHcvpdE8IbndtNAquSVU";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.style.color = isError ? "red" : "green";
    }

    function validatePhone(phone) {
      const isValid = /^\d{10}$/.test(phone);
      document.getElementById("phone-error").textContent = isValid ? "" : "Please enter a valid 10-digit phone number";
      return isValid;
    }

    function validateAadhar(aadhar) {
      const isValid = /^\d{12}$/.test(aadhar);
      document.getElementById("aadhar-error").textContent = isValid ? "" : "Please enter a valid 12-digit Aadhar number";
      return isValid;
    }

    // --- Form submission handler ---
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      
      // Clear all previous errors
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

      // --- Validation (Simplified for clarity) ---
      let isValid = true;
      if (!document.getElementById('username').value) isValid = false;
      if (!validatePhone(document.getElementById('userphone').value)) isValid = false;
      if (!validateAadhar(document.getElementById('userAadhar').value)) isValid = false;
      if (!document.getElementById('vehicleNo').value) isValid = false;
      if (!document.getElementById('vehicleModel').value) isValid = false;

      if (!isValid) {
        showStatus("Please fix the errors in the form.", true);
        return;
      }

      // --- Show loading state ---
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
      showStatus("Submitting your form...");

      try {
        // --- Prepare data for Supabase ---
        const submissionData = {
          name: document.getElementById("username").value,
          phone: document.getElementById("userphone").value,
          aadhar_number: document.getElementById("userAadhar").value,
          vehicle_number: document.getElementById("vehicleNo").value,
          vehicle_model: document.getElementById("vehicleModel").value,
        };

        // --- Insert data into Supabase table ---
        const { data, error } = await supabase
          .from('scrappage_applications')
          .insert([submissionData]);

        if (error) {
          throw error; // Let the catch block handle it
        }

        showStatus("Form submitted successfully!");
        window.location.href = "./pickup.html";
        form.reset();

      } catch (error) {
        console.error("Submission error:", error);
        showStatus(`Error: ${error.message}`, true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = "Submit the Form";
      }
    });

    // --- Real-time input validation ---
    document.getElementById("userphone").addEventListener("input", (e) => validatePhone(e.target.value));
    document.getElementById("userAadhar").addEventListener("input", (e) => validateAadhar(e.target.value));
  });
</script>
  </body>
</html>
